<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Safe Driving Awareness App</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script type="text/javascript" th:src="@{/js/lrm-graphhopper.js}"></script>
</head>
<body>
<div class="d-flex justify-content">
    <p class="m-2">Choose speed increase:</p>
    <div th:each="speedIncreaseOption: ${speedIncreaseOptions}" class="form-check m-2">
        <input th:id="'speedIncreaseRadioBtn' + ${speedIncreaseOption}"
               th:value="${speedIncreaseOption}"
               class="form-check-input"
               type="radio"
               name="speedIncreaseRadioBtn">
        <label class="form-check-label"
               th:for="'speedIncreaseRadioBtn' + ${speedIncreaseOption}"
               th:text="'+' + ${speedIncreaseOption} + 'km/h'">
        </label>
    </div>
</div>
<div id="accordionDiv" class="accordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="speedLimitsAccordionItem">
            <button class="accordion-button"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#speedLimitsCollapse"
                    aria-expanded="false"
                    aria-controls="speedLimitsCollapse">
                Show speed limits
            </button>
        </h2>
        <div id="speedLimitsCollapse"
             class="accordion-collapse collapse hide"
             aria-labelledby="speedLimitsAccordionItem"
             data-bs-parent="#accordionDiv">
            <div class="accordion-body">
                <div id="infoDiv" class="d-flex flex-row">
                    <div id="speedLimitsCard" class="card m-2 w-50">
                        <div class="card-header">
                            Speed limits used
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">These are the new speed values on different road types which will be
                                used to calculate your route:</h6>
                            <ul class="list-group list-group-flush">
                                <li th:each="entry: ${speedLimits}" class="list-group-item">
                                    <span th:text="${entry.key.displayText}"></span>: <span
                                        th:text="${entry.value}"></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div id="penaltiesCard" class="card m-2 flex-grow-1">
                        <div class="card-header">
                            Penalties
                        </div>
                        <p>penalties</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    // TODO add another item for penalties

</div>
<div class="d-flex justify-content">
    <div id="map" class="m-3 w-75" style="height: 600px;"></div>
</div>
<script>
    var prevSelectedOption = undefined;

    $(document).ready(function () {
        $('[id*=speedIncreaseRadioBtn]').on('click', function () {
            var inputValue = $(this).val();
            if (inputValue != prevSelectedOption) {
                $.get('/configurator/speed-info', { option: inputValue }).done(function (fragment) {
                    $("#infoDiv").replaceWith(fragment);
                });
            }
            prevSelectedOption = inputValue;
        })
    });
</script>

<script th:inline="javascript">
    <!--    var map = L.map('map').setView([47.6565584, 23.5719843],16);-->
        var map = L.map('map', { doubleClickZoom: false })
            .setView([45.9432, 24.9668], 7)
            .locate({ setView: true, maxZoom: 16 });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var control = L.Routing.control({
            routeWhileDragging: true,
            geocoder: L.Control.Geocoder.nominatim({
                    serviceUrl: "http://localhost:8081/"
            }),
            router: new L.Routing.GraphHopper(undefined, {
                 serviceUrl: 'http://localhost:8080/route'
            }),
        }).addTo(map);
        control.on('routesfound', function (e) {
            var routes = e.routes;
            var summary = routes[0].summary;
            console.log(summary);
            alert('Total distance is ' + summary.totalDistance / 1000 + ' km and total time is ' + Math.round(summary.totalTime % 3600 / 60) + ' minutes');
        });
</script>

</body>
</html>